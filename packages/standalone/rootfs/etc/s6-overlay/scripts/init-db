#!/bin/bash
set -e

until su postgres -c "/usr/lib/postgresql/17/bin/pg_isready -q"; do
    sleep 1
done

if ! su postgres -c "/usr/lib/postgresql/17/bin/psql -tAc \"SELECT 1 FROM pg_database WHERE datname='keeper'\"" | grep -q 1; then
    su postgres -c "/usr/lib/postgresql/17/bin/createuser -s keeper" || true
    su postgres -c "/usr/lib/postgresql/17/bin/createdb -O keeper keeper"
    su postgres -c "/usr/lib/postgresql/17/bin/psql -c \"ALTER USER keeper WITH PASSWORD 'keeper'\""
fi

cd /app
/root/.bun/bin/bun run --cwd packages/database drizzle-kit migrate
